@model Lab4.Models.CheckoutVM
@{
    ViewData["Title"] = "Checkout";
}

@section Styles {
    <style>
        .checkout-band {
            margin-top: 16px;
            padding: 26px 0 44px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(230,237,233,.98) 0%, rgba(214,228,221,.98) 100%);
            box-shadow: inset 0 1px 0 rgba(255,255,255,.65), inset 0 -1px 0 rgba(0,0,0,.06);
            min-height: calc(100vh - 150px);
        }

        .checkout-pattern {
            position: absolute;
            inset: 0;
            opacity: .55;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='90' viewBox='0 0 140 90'%3E%3Cg fill='none' stroke='%23000000' stroke-opacity='.12' stroke-width='1.6'%3E%3Cpath d='M0 90c23 0 23-46 46-46s23 46 46 46 23-46 46-46'/%3E%3Cpath d='M0 90c23 0 23-30 46-30s23 30 46 30 23-30 46-30'/%3E%3Cpath d='M0 90c23 0 23-15 46-15s23 15 46 15 23-15 46-15'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 170px 110px;
            background-repeat: repeat;
            filter: blur(.15px);
        }

        .checkout-title {
            position: relative;
            z-index: 1;
            text-align: center;
            font-weight: 900;
            letter-spacing: .10em;
            font-size: clamp(46px, 5.7vw, 84px);
            line-height: 1;
            text-transform: uppercase;
            color: transparent;
            -webkit-text-stroke: 3.1px rgba(0,0,0,.30);
            text-shadow: 0 2px 0 rgba(255,255,255,.25), 0 10px 18px rgba(0,0,0,.10);
            transform: translateY(-2px);
        }

            .checkout-title::after {
                content: attr(data-text);
                position: absolute;
                inset: 0;
                text-align: center;
                color: transparent;
                -webkit-text-stroke: 1.5px rgba(255,255,255,.55);
                transform: translateY(1px);
                pointer-events: none;
            }

        .checkout-center {
            position: relative;
            z-index: 1;
            width: min(560px, calc(100% - 40px));
            margin: 56px auto 0;
        }

        .checkout-card {
            border-radius: 10px;
            background: rgba(255,255,255,.72);
            border: 1px solid rgba(0,0,0,.08);
            box-shadow: 0 16px 30px rgba(0,0,0,.16);
            overflow: hidden;
        }

        .checkout-inner {
            padding: 18px 18px 14px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .section-title {
            font-weight: 900;
            letter-spacing: .06em;
            font-size: 12.8px;
            color: rgba(0,0,0,.65);
            text-transform: uppercase;
            margin: 2px 0 10px;
        }

        .c-input, .c-select, .c-textarea {
            width: 100%;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,.18);
            background: rgba(255,255,255,.35);
            box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
            padding: 6px 10px;
            font-size: 12.5px;
            color: rgba(0,0,0,.72);
            outline: none;
        }

        .c-input, .c-select {
            height: 34px;
        }

        .c-textarea {
            min-height: 74px;
            resize: vertical;
            padding-top: 8px;
        }

            .c-input::placeholder, .c-textarea::placeholder {
                color: rgba(0,0,0,.38);
            }

            .c-input:focus, .c-select:focus, .c-textarea:focus {
                border-color: rgba(0,0,0,.26);
                background: rgba(255,255,255,.50);
            }

        .field-row {
            display: grid;
            gap: 9px;
        }

        .field-label {
            font-size: 11.5px;
            color: rgba(0,0,0,.55);
            margin: 2px 0 -4px;
        }

        .validation {
            font-size: 11.5px;
            color: #b00020;
            margin-top: -6px;
        }

        .summary-list {
            display: grid;
            gap: 10px;
            margin-top: 2px;
        }

        .sum-row {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: rgba(0,0,0,.60);
        }

        .sum-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

            .sum-name strong {
                color: rgba(0,0,0,.70);
            }

        .sum-pill {
            min-width: 86px;
            text-align: center;
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,.18);
            background: rgba(255,255,255,.35);
            box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
            font-size: 12px;
            color: rgba(0,0,0,.55);
        }

        .divider {
            height: 1px;
            background: rgba(0,0,0,.10);
            margin: 6px 0;
        }

        .sum-strong {
            color: rgba(0,0,0,.75);
            font-weight: 900;
            letter-spacing: .02em;
        }

        .checkout-actions {
            padding: 0 18px 16px;
            text-align: center;
        }

        .btn-place {
            display: inline-block;
            width: min(320px, 100%);
            height: 38px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,.35);
            background: rgba(0,0,0,.60);
            color: rgba(255,255,255,.92);
            font-weight: 900;
            letter-spacing: .06em;
            font-size: 12.5px;
            box-shadow: 0 12px 18px rgba(0,0,0,.18);
        }

            .btn-place:hover {
                background: rgba(0,0,0,.72);
                color: #fff;
            }

        .checkout-link {
            display: block;
            margin-top: 8px;
            color: rgba(0,0,0,.36);
            text-decoration: none;
            font-size: 12.5px;
        }

            .checkout-link:hover {
                text-decoration: underline;
            }

        .sparkle {
            position: absolute;
            right: 34px;
            bottom: 26px;
            width: 56px;
            height: 56px;
            opacity: .28;
            transform: rotate(12deg);
            pointer-events: none;
        }

        @@media (max-width: 620px) {
            .checkout-inner {
                grid-template-columns: 1fr;
            }

            .checkout-center {
                margin-top: 34px;
            }
        }
    </style>
}

<section class="checkout-band" aria-label="Checkout">
    <div class="checkout-pattern"></div>

    <div class="checkout-title" data-text="CHECKOUT">CHECKOUT</div>

    <div class="checkout-center">
        <form class="checkout-card" asp-action="PlaceOrder" asp-controller="Cart" method="post" novalidate>
            @Html.AntiForgeryToken()

            <div class="checkout-inner">
                <!-- LEFT: CUSTOMER INFO -->
                <div>
                    <div class="section-title">THÔNG TIN KHÁCH</div>

                    <div class="field-row">
                        <div class="field-label">Họ tên</div>
                        <input class="c-input" asp-for="FullName" placeholder="Ví dụ: Nguyễn Văn A" />
                        <span asp-validation-for="FullName" class="validation"></span>

                        <div class="field-label">Số điện thoại</div>
                        <input class="c-input" asp-for="Phone" placeholder="Ví dụ: 0901xxxxxx" />
                        <span asp-validation-for="Phone" class="validation"></span>

                        <div class="field-label">Địa chỉ giao</div>
                        <input class="c-input" asp-for="Address" placeholder="Số nhà, đường, phường/xã..." />
                        <span asp-validation-for="Address" class="validation"></span>

                        <div class="field-label">Quận/Huyện</div>
                        <select class="c-select" id="districtSelect" asp-for="DistrictId">
                            <option value="0">-- Chọn Quận/Huyện --</option>
                        </select>
                        <input type="hidden" asp-for="City" id="cityHidden" />

                        <div class="field-label">Email (tuỳ chọn)</div>
                        <input class="c-input" asp-for="Email" placeholder="abc@email.com" />
                        <span asp-validation-for="Email" class="validation"></span>

                        <div class="field-label">Phương thức thanh toán</div>
                        <select class="c-select" asp-for="PaymentMethod">
                            <option value="COD">COD - Thanh toán khi nhận hàng</option>
                            <option value="BANK">Chuyển khoản ngân hàng</option>
                        </select>
                        <span asp-validation-for="PaymentMethod" class="validation"></span>

                        <div class="field-label">Ghi chú</div>
                        <textarea class="c-textarea" asp-for="Note" placeholder="Ví dụ: ít hành, giao trước 12h..."></textarea>
                        <span asp-validation-for="Note" class="validation"></span>
                    </div>
                </div>

                <!-- RIGHT: ORDER SUMMARY -->
                <div>
                    <div class="section-title">TÓM TẮT ĐƠN</div>

                    <div class="summary-list">
                        @if (Model.Items != null && Model.Items.Any())
                        {
                            @foreach (var it in Model.Items)
                            {
                                <div class="sum-row">
                                    <div class="sum-name">
                                        @if (it.Qty > 1)
                                        {
                                            <span>@it.Qty<span>x</span> @it.Name</span>
                                        }
                                        else
                                        {
                                            if (it.Bold)
                                            {
                                                <strong>@it.Name</strong>
                                            }
                                            else
                                            {
                                                <span>@it.Name</span>
                                            }
                                        }
                                    </div>
                                    <div class="sum-pill">@it.PriceText</div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="sum-row">
                                <div class="sum-name">Chưa có sản phẩm trong giỏ.</div>
                                <div class="sum-pill">0</div>
                            </div>
                        }

                        <div class="divider"></div>

                        <div class="sum-row">
                            <div class="sum-name">Tạm tính</div>
                            <div class="sum-pill">@Model.SubtotalText</div>
                        </div>

                        <div class="sum-row">
                            <div class="sum-name">Thuế</div>
                            <div class="sum-pill">@Model.TaxText</div>
                        </div>
                        @if (Model.DiscountAmount > 0)
                        {
                            <div class="sum-row">
                                <div class="sum-name">Giảm giá</div>
                                <div class="sum-pill" style="color:#2e7d32;">
                                    -@Model.DiscountText
                                </div>
                            </div>
                        }
                        <div class="sum-row">
                            <div class="sum-name">Phí vận chuyển</div>
                            <div class="sum-pill" id="shippingFeeText">@Model.ShippingFeeText</div>
                        </div>
                        <div class="sum-row">
                            <div class="sum-name">Mã giảm giá</div>
                            <div style="display:flex; gap:6px;">
                                <input class="c-input"
                                       asp-for="VoucherCode"
                                       placeholder="Nhập mã..."
                                       style="height:30px; font-size:12px;" />
                            </div>
                        </div>

                        @if (TempData["Error"] != null)
                        {
                            <div style="color:#b00020; font-size:12px; margin-top:4px;">
                                @TempData["Error"]
                            </div>
                        }
                        <div class="sum-row">
                            <div class="sum-name sum-strong">Tổng cộng</div>
                            <div class="sum-pill sum-strong" id="totalText">@Model.TotalText</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="checkout-actions">
                <button type="submit" class="btn-place">ĐẶT MÓN</button>
                <a class="checkout-link" href="/Product/Menu">Tiếp tục chọn món</a>
            </div>
        </form>
    </div>

    <svg class="sparkle" viewBox="0 0 64 64" aria-hidden="true">
        <path fill="rgba(255,255,255,.9)" d="M32 6l4.2 16.4L52 26.7 35.8 31 32 47 28.2 31 12 26.7l15.8-4.3z" />
        <path fill="rgba(255,255,255,.75)" d="M52 38l2.2 8.5L62 49l-7.8 2.1L52 60l-2-8.9L42 49l8-2.5z" />
    </svg>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const districtSelect = document.getElementById('districtSelect');
            const cityHidden = document.getElementById('cityHidden');
            const shippingFeeEl = document.getElementById('shippingFeeText');
            const totalEl = document.getElementById('totalText');

            // Giá trị subtotal + tax từ server (đơn vị đồng)
                   const baseAmount = @((long)(Model.Subtotal - Model.DiscountAmount));
        const tax = @((long)Model.Tax);

            // 1. Load danh sách quận khi trang mở
            fetch('/api/shipping/districts')
                .then(r => r.json())
                .then(districts => {
                    districts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.textContent = d.name + ' (' + d.feeText + ')';
                        districtSelect.appendChild(opt);
                    });
                });

            // 2. Khi chọn quận → gọi API lấy phí ship → cập nhật real-time
            districtSelect.addEventListener('change', function () {
                const districtId = this.value;

                if (!districtId || districtId === '0') {
                    shippingFeeEl.textContent = '0 ₫';
                   totalEl.textContent = formatVnd(baseAmount + tax);
                    cityHidden.value = '';
                    return;
                }

                fetch('/api/shipping/fee?districtId=' + districtId)
                    .then(r => r.json())
                    .then(data => {
                        // Cập nhật phí ship
                        shippingFeeEl.textContent = data.feeText;

                        // Cập nhật tổng cộng
                       const newTotal = baseAmount + tax + data.fee;
                        totalEl.textContent = formatVnd(newTotal);

                        // Gán tên quận vào City hidden
                        cityHidden.value = data.districtName;
                    })
                    .catch(() => {
                        shippingFeeEl.textContent = '0 ₫';
                       totalEl.textContent = formatVnd(baseAmount + tax);
                    });
            });

            // Format số thành VND
            function formatVnd(amount) {
                return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
            }
        })();
    </script>
}
