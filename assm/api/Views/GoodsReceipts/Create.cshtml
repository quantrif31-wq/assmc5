@using Lab4.Models
@model lab4.Models.PurchaseOrder

@{
    var items = Model.Items.ToList();
}

<h2>Nhập kho – Đơn mua #@Model.Code</h2>
<div asp-validation-summary="All" class="text-danger"></div>

<form asp-action="Create" method="post">
    <input type="hidden" name="purchaseOrderId" value="@Model.Id" />

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>SL đặt</th>
                <th>Đã nhận</th>
                <th>Nhập kho</th>
                <th>Giá nhập</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < items.Count; i++)
            {
                var item = items[i];
                <tr>
                    <td>
                        @item.Product.Name
                        <input type="hidden"
                               name="items[@i].ProductId"
                               value="@item.ProductId" />
                    </td>

                    <!-- SL ĐẶT -->
                    <td>@item.QuantityOrdered</td>

                    <!-- ĐÃ NHẬN -->
                    <td>@item.QuantityReceived</td>

                    <!-- NHẬP LẦN NÀY -->
                    <td>
                        <input name="items[@i].Quantity"
                               type="number"
                               min="0"
                               max="@(item.QuantityOrdered - item.QuantityReceived)"
                               class="form-control"
                               required />
                    </td>

                    <!-- GIÁ NHẬP -->
                    <td>
                        <input name="items[@i].UnitCost"
                               class="form-control unit-cost"
                               data-product-id="@item.ProductId"
                               value="@item.UnitPrice"
                               type="number"
                               step="0.01"
                               required />
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <button class="btn btn-primary">
        Xác nhận nhập kho
    </button>
</form>
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const supplierId = @Model.SupplierId;

            document.querySelectorAll(".unit-cost").forEach(input => {
                const productId = input.dataset.productId;

                // nếu PO không có giá hoặc giá = 0
                if (!input.value || input.value == 0) {
                    fetch(`/PurchaseOrders/GetLastPurchasePrice?supplierId=${supplierId}&productId=${productId}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.price && data.price > 0) {
                                input.value = data.price;
                            }
                        });
                }
            });
        });
    </script>
}